name: Сборка TDLib (prebuilt)

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-x86_64
            archive: tar.gz
          - os: windows-2022
            name: windows-x86_64
            archive: zip
          - os: macos-15-intel
            name: macos-x86_64
            archive: tar.gz
          - os: macos-15
            name: macos-aarch64
            archive: tar.gz

    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v4

      - name: Установка зависимостей (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake gperf ninja-build build-essential pkg-config libssl-dev zlib1g-dev zip

      - name: Установка зависимостей (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake gperf openssl@3 ninja
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"

      - name: Установка MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-gperf
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-zlib
            git

      - name: Сборка TDLib (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          git clone --depth 1 https://github.com/tdlib/td.git
          sed -i 's/extern int getopt ([^)]*);/extern int getopt (int argc, char *const argv[], const char *optstring);/' td/td/generate/tl-parser/wgetopt.h || true
          sed -i 's/extern char \\*getenv *( *);/extern char *getenv (const char *);/' td/td/generate/tl-parser/wgetopt.c || true
          cd td
          mkdir build
          cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --target tdjson

      - name: Сборка TDLib
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          OPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR:-}"
          git clone --depth 1 https://github.com/tdlib/td.git
          cd td
          mkdir build
          cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ${OPENSSL_ROOT_DIR:+-DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR"} ..
          cmake --build . --target tdjson

      - name: Подготовка артефакта (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}"
          lib_path="$(find td/build -name "tdjson.dll" -type f | head -n 1)"
          if [[ -z "${lib_path:-}" ]]; then
            echo "tdjson.dll не найден"
            exit 1
          fi
          cp "$lib_path" "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/"
          for dep in libcrypto-3-x64.dll libssl-3-x64.dll libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll zlib1.dll; do
            if [[ -f "/mingw64/bin/$dep" ]]; then
              cp "/mingw64/bin/$dep" "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/"
            fi
          done
          git -C td rev-parse HEAD > "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt"

      - name: Подготовка артефакта
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}"
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            lib_path="$(find td/build -type f -name "libtdjson*.dylib" ! -name "*.a" | head -n 1)"
          else
            lib_path="$(find td/build -type f -name "libtdjson.so*" ! -name "*.a" | head -n 1)"
          fi
          if [[ -z "${lib_path:-}" ]]; then
            echo "libtdjson не найден"
            exit 1
          fi
          cp "$lib_path" "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/"
          git -C td rev-parse HEAD > "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt"

      - name: Архивирование артефакта (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          archive="$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.zip"
          cd "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}"
          zip -r "$archive" .
          cp "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt" "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.commit"
          sha256sum "$archive" | awk '{print $1}' > "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.sha256"

      - name: Архивирование артефакта
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          archive="$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.tar.gz"
          cd "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}"
          tar -czf "$archive" .
          cp "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt" "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.commit"
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$archive" | awk '{print $1}' > "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.sha256"
          else
            shasum -a 256 "$archive" | awk '{print $1}' > "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.sha256"
          fi

      - name: Загрузка артефакта
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-${{ matrix.name }}
          path: |
            out/tdlib/tdlib-${{ matrix.name }}.${{ matrix.archive }}
            out/tdlib/tdlib-${{ matrix.name }}.sha256
            out/tdlib/tdlib-${{ matrix.name }}.commit

  publish:
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: Загрузка артефактов
        uses: actions/download-artifact@v4
        with:
          path: out/tdlib
          merge-multiple: true

      - name: Формирование манифеста
        shell: bash
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${GITHUB_REF_NAME}"
          python3 - <<'PY' "$repo" "$tag"
          import json
          import os
          import sys
          from pathlib import Path

          repo = sys.argv[1]
          tag = sys.argv[2]
          base = Path("out/tdlib")
          assets = []

          for archive in sorted(base.glob("tdlib-*.zip")) + sorted(base.glob("tdlib-*.tar.gz")):
              name = archive.name
              platform = name.replace("tdlib-", "").replace(".zip", "").replace(".tar.gz", "")
              sha_file = base / f"tdlib-{platform}.sha256"
              commit_file = base / f"tdlib-{platform}.commit"
              sha256 = sha_file.read_text().strip() if sha_file.exists() else ""
              commit = commit_file.read_text().strip() if commit_file.exists() else ""
              url = f"https://github.com/{repo}/releases/download/{tag}/{name}"
              assets.append({
                  "platform": platform,
                  "file": name,
                  "sha256": sha256,
                  "size": archive.stat().st_size,
                  "url": url,
                  "tdlib_commit": commit
              })

          manifest = {
              "version": tag,
              "created_at": __import__("datetime").datetime.utcnow().isoformat() + "Z",
              "assets": assets
          }

          out_path = base / "tdlib-manifest.json"
          out_path.write_text(json.dumps(manifest, ensure_ascii=False, indent=2))
          print(f"manifest: {out_path}")
          PY

      - name: Публикация в релиз
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/tdlib/tdlib-*.zip
            out/tdlib/tdlib-*.tar.gz
            out/tdlib/tdlib-*.sha256
            out/tdlib/tdlib-*.commit
            out/tdlib/tdlib-manifest.json

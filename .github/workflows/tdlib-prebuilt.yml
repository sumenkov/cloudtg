name: Сборка TDLib (prebuilt)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Тег релиза TDLib (например tdlib-prebuilt)"
        required: true
        default: "tdlib-prebuilt"
      target_sha:
        description: "Коммит или ветка для релиза (необязательно)"
        required: false
        default: ""
      release_name:
        description: "Название релиза"
        required: false
        default: "TDLib prebuilt"
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref_name, 'tdlib-')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: linux-x86_64
            archive: tar.gz
          - os: windows-2022
            name: windows-x86_64
            archive: zip
          - os: macos-15-intel
            name: macos-x86_64
            archive: tar.gz
          - os: macos-15
            name: macos-aarch64
            archive: tar.gz

    steps:
      - name: Клонирование репозитория
        uses: actions/checkout@v4

      - name: Установка зависимостей (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake gperf ninja-build build-essential pkg-config libssl-dev zlib1g-dev zip

      - name: Установка зависимостей (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake gperf openssl@3 ninja
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> "$GITHUB_ENV"

      - name: Установка зависимостей (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install gperf -y
          $vcpkg = "C:\\vcpkg"
          & "$vcpkg\\vcpkg.exe" install openssl:x64-windows zlib:x64-windows

      - name: Сборка TDLib (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          git clone --depth 1 https://github.com/tdlib/td.git
          New-Item -ItemType Directory -Force -Path td/build | Out-Null
          Set-Location td/build
          cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ..
          cmake --build . --config Release --target tdjson

      - name: Сборка TDLib
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          OPENSSL_ROOT_DIR="${OPENSSL_ROOT_DIR:-}"
          git clone --depth 1 https://github.com/tdlib/td.git
          cd td
          mkdir build
          cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release ${OPENSSL_ROOT_DIR:+-DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR"} ..
          cmake --build . --target tdjson

      - name: Подготовка артефакта (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $outDir = Join-Path $env:GITHUB_WORKSPACE "out/tdlib/${{ matrix.name }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $libPath = Get-ChildItem -Path "td/build" -Recurse -Filter "tdjson.dll" | Select-Object -First 1
          if (-not $libPath) {
            Write-Error "tdjson.dll не найден"
            exit 1
          }
          Copy-Item $libPath.FullName -Destination $outDir -Force

          # TDLib on Windows often depends on vcpkg-provided runtime DLLs (OpenSSL, zlib).
          # Bundle them вместе с tdjson.dll, чтобы portable-версии не ломались на чистых системах.
          $vcpkgBin = "C:\\vcpkg\\installed\\x64-windows\\bin"
          if (Test-Path $vcpkgBin) {
            $patterns = @("libcrypto*.dll", "libssl*.dll", "zlib1.dll")
            foreach ($pattern in $patterns) {
              Get-ChildItem -Path $vcpkgBin -Filter $pattern -ErrorAction SilentlyContinue | ForEach-Object {
                Copy-Item $_.FullName -Destination $outDir -Force
              }
            }
          } else {
            Write-Host "vcpkg bin не найден: $vcpkgBin (пропускаю копирование зависимостей)"
          }

          $commit = git -C td rev-parse HEAD
          $commit | Out-File -FilePath (Join-Path $outDir "TDLIB_COMMIT.txt") -Encoding utf8 -NoNewline

      - name: Подготовка артефакта
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}"
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            lib_path="$(find td/build -name "libtdjson*.dylib" ! -name "*.a" | head -n 1)"
          else
            lib_path="$(find td/build -type f -name "libtdjson.so*" ! -name "*.a" | head -n 1)"
          fi
          if [[ -z "${lib_path:-}" ]]; then
            echo "libtdjson не найден"
            exit 1
          fi
          cp "$lib_path" "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/"
          git -C td rev-parse HEAD > "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt"

      - name: Архивирование артефакта (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $archive = Join-Path $env:GITHUB_WORKSPACE "out/tdlib/tdlib-${{ matrix.name }}.zip"
          $src = Join-Path $env:GITHUB_WORKSPACE "out/tdlib/${{ matrix.name }}/*"
          Compress-Archive -Path $src -DestinationPath $archive -Force
          Copy-Item (Join-Path $env:GITHUB_WORKSPACE "out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt") `
            (Join-Path $env:GITHUB_WORKSPACE "out/tdlib/tdlib-${{ matrix.name }}.commit") -Force
          $hash = (Get-FileHash -Algorithm SHA256 -Path $archive).Hash.ToLower()
          $hash | Out-File -FilePath (Join-Path $env:GITHUB_WORKSPACE "out/tdlib/tdlib-${{ matrix.name }}.sha256") -Encoding ascii -NoNewline

      - name: Архивирование артефакта
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          archive="$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.tar.gz"
          cd "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}"
          tar -czf "$archive" .
          cp "$GITHUB_WORKSPACE/out/tdlib/${{ matrix.name }}/TDLIB_COMMIT.txt" "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.commit"
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$archive" | awk '{print $1}' > "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.sha256"
          else
            shasum -a 256 "$archive" | awk '{print $1}' > "$GITHUB_WORKSPACE/out/tdlib/tdlib-${{ matrix.name }}.sha256"
          fi

      - name: Загрузка артефакта
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-${{ matrix.name }}
          path: |
            out/tdlib/tdlib-${{ matrix.name }}.${{ matrix.archive }}
            out/tdlib/tdlib-${{ matrix.name }}.sha256
            out/tdlib/tdlib-${{ matrix.name }}.commit

  publish:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref_name, 'tdlib-')
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - name: Загрузка артефактов
        uses: actions/download-artifact@v4
        with:
          path: out/tdlib
          merge-multiple: true

      - name: Подготовка параметров релиза
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "name=TDLib ${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "target=" >> "$GITHUB_OUTPUT"
          else
            tag="${{ inputs.tag_name }}"
            if [[ -z "$tag" ]]; then
              tag="tdlib-prebuilt"
            fi
            name="${{ inputs.release_name }}"
            if [[ -z "$name" ]]; then
              name="TDLib prebuilt"
            fi
            target="${{ inputs.target_sha }}"
            echo "tag=$tag" >> "$GITHUB_OUTPUT"
            echo "name=$name" >> "$GITHUB_OUTPUT"
            echo "target=$target" >> "$GITHUB_OUTPUT"
          fi

      - name: Формирование манифеста
        shell: bash
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${{ steps.release_meta.outputs.tag }}"
          python3 - <<'PY' "$repo" "$tag"
          import json
          import os
          import sys
          from pathlib import Path

          repo = sys.argv[1]
          tag = sys.argv[2]
          base = Path("out/tdlib")
          assets = []

          for archive in sorted(base.glob("tdlib-*.zip")) + sorted(base.glob("tdlib-*.tar.gz")):
              name = archive.name
              platform = name.replace("tdlib-", "").replace(".zip", "").replace(".tar.gz", "")
              sha_file = base / f"tdlib-{platform}.sha256"
              commit_file = base / f"tdlib-{platform}.commit"
              sha256 = sha_file.read_text().strip() if sha_file.exists() else ""
              commit = commit_file.read_text().strip() if commit_file.exists() else ""
              url = f"https://github.com/{repo}/releases/download/{tag}/{name}"
              assets.append({
                  "platform": platform,
                  "file": name,
                  "sha256": sha256,
                  "size": archive.stat().st_size,
                  "url": url,
                  "tdlib_commit": commit
              })

          manifest = {
              "version": tag,
              "created_at": __import__("datetime").datetime.utcnow().isoformat() + "Z",
              "assets": assets
          }

          out_path = base / "tdlib-manifest.json"
          out_path.write_text(json.dumps(manifest, ensure_ascii=False, indent=2))
          print(f"manifest: {out_path}")
          PY

      - name: Публикация в релиз
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          target_commitish: ${{ steps.release_meta.outputs.target }}
          name: ${{ steps.release_meta.outputs.name }}
          make_latest: false
          files: |
            out/tdlib/tdlib-*.zip
            out/tdlib/tdlib-*.tar.gz
            out/tdlib/tdlib-*.sha256
            out/tdlib/tdlib-*.commit
            out/tdlib/tdlib-manifest.json

name: Release CloudTG App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Тег релиза (например v1.0.4)"
        required: true
      release_name:
        description: "Название релиза (если пусто, берется tag)"
        required: false
      prerelease:
        description: "Отметить релиз как prerelease"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2022
            name: windows-x86_64
          - os: ubuntu-22.04
            name: linux-x86_64
          - os: macos-15-intel
            name: macos-x86_64
            mac_artifact: CloudTG-macos-x86_64.dmg
          - os: macos-15
            name: macos-aarch64
            mac_artifact: CloudTG-macos-aarch64.dmg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies for Tauri
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install npm dependencies
        run: npm ci

      - name: Download prebuilt TDLib (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          CLOUDTG_TDLIB_REPO: ${{ github.repository }}
          CLOUDTG_TDLIB_MANIFEST_URL: https://github.com/${{ github.repository }}/releases/download/tdlib-prebuilt/tdlib-manifest.json
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run tdlib:fetch

      - name: Download prebuilt TDLib (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          CLOUDTG_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"
          $manifestUrl = "https://github.com/$env:CLOUDTG_REPO/releases/download/tdlib-prebuilt/tdlib-manifest.json"
          $headers = @{ "Accept" = "application/vnd.github+json" }
          if ($env:GITHUB_TOKEN) {
            $headers["Authorization"] = "Bearer $env:GITHUB_TOKEN"
          }

          $manifest = Invoke-RestMethod -Uri $manifestUrl -Headers $headers
          $entry = $manifest.assets | Where-Object { $_.platform -eq "windows-x86_64" } | Select-Object -First 1
          if (-not $entry) {
            throw "В tdlib-manifest.json отсутствует платформа windows-x86_64"
          }

          $dest = Join-Path $env:GITHUB_WORKSPACE "src-tauri/resources/tdlib/windows-x86_64"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          $tmp = Join-Path $env:RUNNER_TEMP "tdlib-windows-x86_64.zip"
          Invoke-WebRequest -Uri $entry.url -Headers $headers -OutFile $tmp

          if ($entry.sha256) {
            $hash = (Get-FileHash -Algorithm SHA256 -Path $tmp).Hash.ToLower()
            if ($hash -ne $entry.sha256.ToLower()) {
              throw "Checksum TDLib не совпадает"
            }
          }

          Expand-Archive -Path $tmp -DestinationPath $dest -Force
          if (-not (Test-Path (Join-Path $dest "tdjson.dll"))) {
            throw "tdjson.dll не найден после распаковки"
          }

      - name: Build app
        run: npm run tauri:build

      - name: Pack Windows portable zip
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          New-Item -ItemType Directory -Force -Path portable | Out-Null

          $exePath = "src-tauri/target/release/cloudtg.exe"
          if (-not (Test-Path $exePath)) {
            throw "Не найден бинарник: $exePath"
          }
          Copy-Item $exePath "portable/CloudTG.exe" -Force

          $dllPath = "src-tauri/resources/tdlib/windows-x86_64/tdjson.dll"
          if (-not (Test-Path $dllPath)) {
            throw "Не найден TDLib: $dllPath"
          }
          Copy-Item $dllPath "portable/tdjson.dll" -Force

          Compress-Archive -Path "portable/*" -DestinationPath "dist/CloudTG-windows-portable-x86_64.zip" -Force

      - name: Collect Linux AppImage
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          appimage="$(find src-tauri/target/release/bundle/appimage -maxdepth 1 -type f -name '*.AppImage' | head -n 1 || true)"
          if [[ -z "${appimage}" ]]; then
            echo "Не найден AppImage в src-tauri/target/release/bundle/appimage"
            exit 1
          fi
          cp "$appimage" "dist/CloudTG-linux-x86_64.AppImage"

      - name: Collect macOS DMG
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          dmg="$(find src-tauri/target/release/bundle/dmg -maxdepth 1 -type f -name '*.dmg' | head -n 1 || true)"
          if [[ -z "${dmg}" ]]; then
            echo "Не найден DMG в src-tauri/target/release/bundle/dmg"
            exit 1
          fi
          cp "$dmg" "dist/${{ matrix.mac_artifact }}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.name }}
          path: dist/*
          if-no-files-found: error

  publish:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          merge-multiple: true
          path: release-assets

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "push" ]]; then
            tag="${GITHUB_REF_NAME}"
            name="${GITHUB_REF_NAME}"
            prerelease="false"
          else
            tag="${{ inputs.tag_name }}"
            if [[ -z "${tag}" ]]; then
              echo "tag_name обязателен для workflow_dispatch"
              exit 1
            fi
            name="${{ inputs.release_name }}"
            if [[ -z "${name}" ]]; then
              name="${tag}"
            fi
            prerelease="${{ inputs.prerelease }}"
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "name=${name}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${prerelease}" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          prerelease: ${{ steps.meta.outputs.prerelease == 'true' }}
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            release-assets/CloudTG-windows-portable-x86_64.zip
            release-assets/CloudTG-linux-x86_64.AppImage
            release-assets/CloudTG-macos-x86_64.dmg
            release-assets/CloudTG-macos-aarch64.dmg

# Технический аудит CloudTG (2026-02-09)

## Что проверено
- Сборка и тесты UI (`npm test`, `npm --workspace ui run build`).
- Тесты Rust (`cargo test --manifest-path src-tauri/Cargo.toml`).
- Проверка форматирования Rust (`cargo fmt --check`).
- Линт Rust (`cargo clippy --all-targets -- -D warnings`).
- Проверка наличия линта UI (`npm --workspace ui run lint`).
- Проверка `README` на соответствие текущим возможностям.
- Ручной обзор безопасности и практик в ключевых модулях:
  - `src-tauri/src/commands.rs`
  - `src-tauri/src/app/files.rs`
  - `src-tauri/src/secrets.rs`
  - `ui/src/pages/App.tsx`
  - `ui/src/components/FileManager.tsx`

## Результаты проверок
- `npm test`: успешно.
- `npm --workspace ui run build`: успешно.
- `cargo test`: успешно.
- `cargo fmt --check`: не проходит (в проекте много неотформатированных Rust-файлов).
- `cargo clippy -D warnings`: не проходит (накопленный технический долг по стилю/архитектуре).
- `npm --workspace ui run lint`: не проходит, т.к. в `ui/package.json` нет скрипта `lint`.

## Безопасность и практики
### Исправлено в этом проходе
- Убрано потенциально небезопасное открытие файла через `cmd /C start` на Windows:
  - теперь используется прямой вызов `explorer` без shell-интерпретации.
  - файл: `src-tauri/src/commands.rs`.
- Исправлен риск утечки long-lived listeners в React-экране приложения:
  - добавлен безопасный cleanup для асинхронной регистрации подписок.
  - файл: `ui/src/pages/App.tsx`.
- Закрыт риск path traversal в локальном кеше загрузок:
  - в `sanitize_component` запрещены `.`/`..`, control-символы и `\0`;
  - добавлены тесты на нормализацию опасных имён;
  - файл: `src-tauri/src/app/files.rs`.
- Добавлен `Default` для `AppState` как базовая best-practice:
  - файл: `src-tauri/src/state.rs`.

### Оставшиеся риски/замечания
- В `src-tauri/tauri.conf.json` установлено `"csp": null`.
  - Это упрощает разработку, но ослабляет защиту WebView.
  - Рекомендуется перейти на явную CSP-политику и протестировать UI на совместимость.
- `cargo clippy` показывает большое количество предупреждений.
  - Часть низкого риска (стиль), часть среднего (слишком сложные сигнатуры/функции, потенциальные сложности сопровождения).
- `run_command` в `src-tauri/src/telegram/tdlib.rs` использует `reader.lines().flatten()`.
  - По clippy это риск «бесконечного» цикла ошибок чтения (`lines_filter_map_ok`).
  - Рекомендуется заменить на `map_while(Result::ok)`.
- UI-модуль `ui/src/components/FileManager.tsx` остается монолитным (более 1200 строк).
  - Это усложняет поддержку и локализацию регрессий.
  - Рекомендуется декомпозировать на `FileList`, `TreePanel`, `SharePanel`, `SearchPanel`.

## Зависимости и уязвимости
### Что удалось
- Проверка состояния зависимостей через lock-файлы и текущие сборки.
- Верификация, что проект собирается и тесты проходят на текущих версиях.

### Блокеры среды
- `npm audit`, `npm outdated`, `cargo update` и сетевые проверки не завершились из-за недоступности реестров:
  - `registry.npmjs.org` и `index.crates.io` не резолвятся в текущей среде.
- `cargo audit` и `cargo outdated` не установлены в окружении.

### Рекомендация
- После восстановления доступа к сети выполнить:
  - `npm audit --json`
  - `npm outdated --json`
  - `cargo install cargo-audit cargo-outdated`
  - `cargo audit`
  - `cargo outdated --root-deps-only`
  - затем зафиксировать обновления зависимостей отдельным коммитом.

## Покрытие тестами (фактическая оценка)
- UI:
  - исходники: ~2658 строк (`ui/src`),
  - тесты: ~288 строк (`ui/src/__tests__`),
  - автотестов: 10.
- Rust:
  - исходники: ~7574 строк (`src-tauri/src`),
  - интеграционные тесты: 27 строк (`src-tauri/tests`),
  - unit-тестов: 7.

### Вывод
- Покрытие критически важных сценариев пока точечное.
- Рекомендуется считать текущее покрытие **низким** для backend и **ниже среднего** для UI.

### Приоритетные зоны для новых тестов
1. `src-tauri/src/commands.rs`:
   - `file_open`, `file_download`, `file_open_folder` (ветки локального файла, догрузка, ошибки).
2. `src-tauri/src/app/files.rs`:
   - `download_file` (overwrite/without overwrite, актуализация размера, fallback при смене `tg_msg_id`).
3. `src-tauri/src/secrets.rs`:
   - шифрование/дешифрование, неверный пароль, миграционные и edge-case сценарии.
4. `ui/src/pages/App.tsx`:
   - регистрация/очистка listener-ов, поведение при `auth_state_changed`.
5. `ui/src/components/FileManager.tsx`:
   - сценарии кнопок `Скачать/Открыть/Открыть папку` и отображение размера.

## Проверка README
### Что обновлено
- Уточнено поведение локальных копий:
  - без дублирования при повторном скачивании;
  - подтверждение перезаписи;
  - логика `Открыть`/`Открыть папку`;
  - отображение размера (`0 Б` до скачивания, фактический после).
- Добавлена заметка по запуску coverage для UI-тестов.
- Добавлено уточнение по ограничениям инструмента покрытия:
  - для `vitest --coverage` требуется `@vitest/coverage-v8`.

### Что ещё можно улучшить
- Добавить отдельный раздел «Безопасность и хранение ключей» с явным threat model.
- Добавить короткий troubleshooting-блок по сетевым ограничениям реестров npm/crates.

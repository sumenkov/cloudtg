# CloudTG: справка по функциям и навигации

Этот документ описывает, как ориентироваться в CloudTG, где настраивать подключение и что делать в типовых проблемах.

## 1. Что делает CloudTG
CloudTG хранит структуру папок и файлы в Telegram-канале **CloudTG**, а локально держит индекс и кеш для быстрого доступа.

Также используется отдельный канал **CloudTG Backups** для резервных копий локальной базы.

## 2. Навигация по интерфейсу

### 2.1 Верхняя панель
- `Справка` — открыть встроенный хелпер с описанием функций и навигации.
- `Настройки` / `Закрыть` — открыть или закрыть окно настроек.
- `Выйти` — разлогиниться из Telegram в CloudTG (доступно после авторизации).
- `Обновить сейчас` — запустить синхронизацию с каналом хранения.

### 2.2 Основной экран
Слева:
- дерево папок.

Справа:
- рабочая область с вкладками.

Вкладки:
- `Файлы` — загрузка, скачивание, открытие, удаление и шаринг файлов.
- `Папки` — создание, переименование, перенос и удаление папок.
- `Поиск` — поиск по имени и/или расширению.
- `Сервис` — служебные операции и восстановление поврежденной папки.

## 3. Быстрые сценарии

### 3.1 Первый запуск
1. Открой `Настройки`.
2. В разделе `Подключение Telegram` укажи `API_ID` и `API_HASH`.
3. Выбери режим хранения ключей.
4. Проверь путь к TDLib (или оставь автоопределение).
5. Нажми `Сохранить подключение`.
6. Вернись на главный экран и пройди авторизацию.
7. Нажми `Обновить сейчас`.

### 3.2 Где взять API_ID и API_HASH
1. Открой `my.telegram.org` и войди по номеру телефона.
2. Перейди в `API development tools`.
3. Создай приложение.
4. Скопируй `API ID` и `API Hash` в CloudTG.

Важно:
- не публикуй `API_HASH` в репозитории, issue и скриншотах;
- если собираешь приложение с вшитыми ключами, считай их публичными.

### 3.3 Открытие справки
Нажми кнопку `Справка` в верхней панели.

Откроется отдельное окно поверх интерфейса с текстом хелпера.

### 3.4 Загрузка файлов
Вкладка `Файлы`:
- кнопка `Выбрать и загрузить`;
- либо перетаскивание файлов в область загрузки.

### 3.5 Если отправить файл напрямую в Telegram-канал
Если файл отправлен вручную в канал **CloudTG**, он будет импортирован при синхронизации.

Если у сообщения нет корректного тега папки, файл попадет в папку **Неразобранное**.

### 3.6 Скачивание и открытие
Вкладка `Файлы`, у строки файла:
- `Скачать` — загрузить локальную копию;
- `Открыть` — открыть уже скачанный файл;
- `⋯ Действия` -> `Открыть папку` — открыть папку с локальной копией.

Во время скачивания показывается статус активной загрузки.

### 3.7 Поиск
Вкладка `Поиск`:
- поле имени;
- поле расширения/типа;
- переключатель поиска по текущей папке или по всему хранилищу.

### 3.8 Шаринг файлов в чат
Вкладка `Файлы` -> `⋯ Действия` -> `Поделиться`:
- выбери чат из недавних или найди через поиск;
- отправь файл в выбранный чат.

## 4. Раздел «Настройки»

### 4.1 Подключение Telegram
- API-ключи (`API_ID`, `API_HASH`)
- режим хранения секретов
- путь к TDLib
- проверка отправки тестового сообщения

### 4.2 Обслуживание хранилища
- Проверка целостности последних сообщений
- Бэкап базы (`Создать бэкап`)
- Восстановление базы из бэкапа
- Каналы хранения:
  - `Открыть канал бэкапов`
  - `Создать новый канал CloudTG`
- Кеш TDLib:
  - оценка размера
  - очистка кеша

Поведение восстановления:
- `Восстановить базу из бэкапа` использует последний бэкап из канала `CloudTG Backups`.
- если бэкап старее данных в канале хранения, база может быть пересобрана из сообщений.
- после восстановления обычно требуется перезапуск приложения.

## 5. Где лежат данные и логи
По умолчанию CloudTG хранит данные рядом с исполняемым файлом:
- `./data` (SQLite: `cloudtg.sqlite`)
- `./cache` (включая локальные скачанные файлы)
- `./logs` (логи)

На Linux/macOS, если рядом с бинарем нет прав на запись, данные переносятся в пользовательскую директорию:
- Linux: `$XDG_DATA_HOME/cloudtg` или `~/.local/share/cloudtg`
- macOS: `~/Library/Application Support/CloudTG`

Переменные окружения:
- `CLOUDTG_BASE_DIR` — базовая директория для `data/cache/logs`
- `CLOUDTG_STORAGE_DIR` — директория хранения на Linux/macOS

## 6. TDLib: что важно знать
CloudTG не работает без TDLib (`tdjson.dll` / `libtdjson`).

Порядок поиска библиотеки:
1. Путь из настроек (`Путь к TDLib`)
2. `CLOUDTG_TDLIB_PATH`
3. Рядом с программой
4. Ресурсы приложения
5. Автоскачивание из релизов
6. Локальная сборка TDLib

### 6.1 Ошибка на Windows `LoadLibraryExW failed`
Обычно это значит, что `tdjson.dll` найдена, но не найдены её зависимости.

Проверь:
- совпадает ли разрядность (x64/x86)
- лежат ли зависимые DLL рядом с `tdjson.dll`
- установлен ли Visual C++ Runtime

### 6.2 Ручная загрузка предсобранной TDLib
Через npm:
```bash
npm run tdlib:fetch
```

Linux/macOS:
```bash
./scripts/fetch-tdlib.sh
```

Windows PowerShell:
```powershell
.\scripts\fetch-tdlib.ps1
```

Переменные для автоскачивания TDLib:
- `CLOUDTG_TDLIB_REPO=owner/repo`
- `CLOUDTG_TDLIB_MANIFEST_URL=.../tdlib-manifest.json`
- `GITHUB_TOKEN` или `GH_TOKEN` (если репозиторий приватный)

## 7. Безопасность ключей
- CloudTG не хранит `API_ID/API_HASH` в своей базе.
- Ключи можно хранить в системном keychain или в зашифрованном файле.
- Режим «только в текущем запуске» не пишет ключи на диск.

Рекомендации:
- не публикуй `API_HASH`;
- используй сильный пароль при режиме «зашифрованный файл»;
- при подозрении на утечку перевыпусти `API_HASH` на `my.telegram.org`.

## 8. Если что-то не работает
- Проверь разделы статуса в `Настройки`.
- Проверь, что TDLib доступна.
- Запусти `Обновить сейчас` повторно.
- Посмотри логи:
  - portable: `./logs/cloudtg.jsonl.YYYY-MM-DD`
  - Linux/macOS с storage dir: `CLOUDTG_STORAGE_DIR/logs`

## 9. Где сообщить о проблеме
- GitHub Issues: https://github.com/sumenkov/cloudtg/issues

Что приложить:
- ОС и версию CloudTG
- шаги воспроизведения
- фрагмент лога

Не прикладывай `API_HASH`.
